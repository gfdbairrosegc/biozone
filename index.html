<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador Bioclimático de Givoni</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para o loader */
        .loader {
            border: 5px solid #4a5568; /* cinza escuro */
            border-top: 5px solid #4299e1; /* azul */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #summary-table-body tr.interactive {
            cursor: pointer;
            transition: background-color 0.2s;
        }
         #summary-table-body tr.interactive:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .fullscreen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            height: 90vh;
            max-width: 1400px;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="backdrop" class="hidden fixed inset-0 bg-black bg-opacity-70 z-40"></div>
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white text-center">Analisador Bioclimático Interativo</h1>
            <p class="text-gray-400 mt-2 text-center">Visualize dados de arquivos EPW na Carta de Givoni para análise de estratégias de projeto passivo.</p>
        </header>

        <main class="bg-gray-800 border border-gray-700 rounded-lg p-6">
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Seção de Controle -->
                <div class="w-full md:w-1/3">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Controles</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="epw-file" class="block mb-2 text-sm font-medium text-gray-300">1. Selecione o arquivo EPW:</label>
                             <p class="text-xs text-gray-400 mb-2">Sugestão para baixar arquivos EPW: acesse o <a href="https://www.ladybug.tools/epwmap/" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Ladybug Tools EPW Map</a> e encontre a cidade desejada.</p>
                            <input type="file" id="epw-file" accept=".epw" class="block w-full text-sm text-gray-400
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-900 file:text-blue-300
                                hover:file:bg-blue-800 cursor-pointer"
                            >
                            <p id="file-info" class="text-xs text-gray-500 mt-2"></p>
                        </div>

                        <button id="analyze-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-500">
                            Analisar
                        </button>
                        
                         <div id="loader" class="hidden mx-auto loader"></div>
                    </div>
                    
                    <div id="comfort-summary" class="mt-8 hidden">
                         <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Resumo de Conforto Interno</h2>
                         <div class="space-y-3 text-sm p-2">
                             <div class="flex justify-between items-center">
                                <span class="flex items-center">
                                    <span class="inline-block w-3 h-3 rounded-full mr-2 bg-green-500"></span>
                                    Confortável:
                                </span>
                                <span id="comfortable-percent" class="font-bold">--%</span>
                            </div>
                             <div class="flex justify-between items-center">
                                <span class="flex items-center">
                                    <span class="inline-block w-3 h-3 rounded-full mr-2 bg-red-500"></span>
                                    Não Confortável:
                                </span>
                                <span id="uncomfortable-percent" class="font-bold">--%</span>
                            </div>
                         </div>
                    </div>

                    <div id="chart-explanation" class="mt-8 hidden">
                        <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Como Ler o Gráfico</h2>
                        <div class="text-xs text-gray-400 space-y-3 p-2">
                            <p><strong>Temperatura de Bulbo Seco (°C):</strong> O eixo horizontal (X) representa a temperatura do ar, a medida mais comum que usamos no dia a dia.</p>
                            <p><strong>Umidade Absoluta (g/kg):</strong> O eixo vertical (Y) indica a quantidade real de vapor d'água presente em 1kg de ar seco. É uma medida precisa da umidade, crucial para a análise de conforto térmico.</p>
                            <p><strong>Umidade Relativa (%):</strong> As linhas curvas mostram a porcentagem de umidade no ar em relação ao máximo que ele poderia conter naquela temperatura. Quanto mais quente o ar, mais vapor d'água ele consegue reter.</p>
                            <p><strong>Zonas Bioclimáticas:</strong> As áreas coloridas representam as diferentes estratégias de projeto que podem ser usadas para trazer as condições externas para dentro da zona de conforto.</p>
                        </div>
                   </div>
                </div>

                <!-- Seção do Gráfico e Legenda -->
                <div class="w-full md:w-2/3">
                    <div id="location-display" class="mb-4 text-center text-gray-400 h-6"></div>
                    <div id="chart-container" class="relative bg-gray-900 p-2 rounded-lg" style="height:500px;">
                        <button id="fullscreen-button" class="absolute top-4 right-4 z-20 p-2 bg-gray-700 rounded-full hover:bg-gray-600 transition hidden">
                            <svg id="expand-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/>
                            </svg>
                            <svg id="compress-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-fullscreen-exit hidden" viewBox="0 0 16 16">
                                <path d="M5.5 0a.5.5 0 0 1 .5.5v4A.5.5 0 0 1 5 5h-4a.5.5 0 0 1 0-1h3.5V.5a.5.5 0 0 1 .5-.5zm0 11a.5.5 0 0 1 .5.5v3.5h-3.5a.5.5 0 0 1 0-1H5v-3a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3.5a.5.5 0 0 1 0-1H10.5v-3.5a.5.5 0 0 1 .5-.5zM11 0a.5.5 0 0 1 .5.5v3.5h3.5a.5.5 0 0 1 0 1H11v3a.5.5 0 0 1-1 0v-4A.5.5 0 0 1 11 0z"/>
                            </svg>
                        </button>
                        <canvas id="givoni-chart"></canvas>
                         <div id="chart-placeholder" class="absolute inset-0 flex items-center justify-center bg-gray-800 rounded-lg">
                            <p class="text-gray-500">O gráfico aparecerá aqui após a análise.</p>
                        </div>
                    </div>
                     <!-- Área de Análise movida para debaixo do gráfico -->
                    <div id="analysis-results" class="mt-8 hidden">
                         <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                             <div>
                                <h2 class="text-xl font-semibold">Análise e Legenda Interativa</h2>
                                <p class="text-xs text-gray-400">Clique nas linhas para habilitar/desabilitar as zonas no gráfico.</p>
                             </div>
                             <button id="toggle-all-button" class="bg-gray-600 text-white font-bold py-1.5 px-3 rounded-lg text-xs hover:bg-gray-700 transition duration-300 hidden">
                                Ativar/Desativar
                            </button>
                         </div>
                         <div id="summary" class="text-sm space-y-2">
                            <table class="w-full text-left">
                                <thead class="border-b-2 border-gray-600">
                                    <tr>
                                        <th class="py-1">Estratégia Bioclimática</th>
                                        <th class="py-1 text-center">Horas</th>
                                        <th class="py-1 text-right">%</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body">
                                    <!-- Os resultados serão inseridos aqui via JavaScript -->
                                </tbody>
                            </table>
                         </div>
                    </div>

                    <div id="strategy-analysis" class="mt-8 hidden">
                        <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Análise de Estratégias Bioclimáticas</h2>
                        <div id="analysis-text" class="text-sm space-y-3 p-4 bg-gray-800 rounded-lg border border-gray-700">
                            <!-- O texto da análise será inserido aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center text-xs text-gray-500 mt-8 pt-4 border-t border-gray-700">
            <p>Desenvolvido por Gabriel Fernando D. de Bairros</p>
            <p>Arquitetura e Urbanismo | Engenharia Civil - UESC 2025</p>
            <p class="mt-1 text-gray-600">Criado com o auxílio de ferramentas de Inteligência Artificial</p>
        </footer>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        window.onload = function() {

            const fileInput = document.getElementById('epw-file');
            const analyzeButton = document.getElementById('analyze-button');
            const toggleAllButton = document.getElementById('toggle-all-button');
            const fullscreenButton = document.getElementById('fullscreen-button');
            const expandIcon = document.getElementById('expand-icon');
            const compressIcon = document.getElementById('compress-icon');
            const chartContainer = document.getElementById('chart-container');
            const backdrop = document.getElementById('backdrop');
            const fileInfo = document.getElementById('file-info');
            const loader = document.getElementById('loader');
            const chartPlaceholder = document.getElementById('chart-placeholder');
            const analysisResults = document.getElementById('analysis-results');
            const summaryTableBody = document.getElementById('summary-table-body');
            const locationDisplay = document.getElementById('location-display');
            const comfortSummaryDiv = document.getElementById('comfort-summary');
            const comfortablePercentSpan = document.getElementById('comfortable-percent');
            const uncomfortablePercentSpan = document.getElementById('uncomfortable-percent');
            const strategyAnalysisDiv = document.getElementById('strategy-analysis');
            const analysisTextDiv = document.getElementById('analysis-text');
            const chartExplanationDiv = document.getElementById('chart-explanation');

            let epwData = null;
            let givoniChart = null;
            let zonesWithAH = {};
            
            const ANALYSIS_PRIORITY_ORDER = [
                'zone5_airConditioning', 'zone2_4_intersection', 'zone2_ventilation', 'zone4_thermalMassCooling', 'zone1_comfort',
                'zone3_evaporativeCooling', 'zone6_humidification', 'zone7_thermalMassHeating',
                'zone8_passiveSolarHeating', 'zone9_artificialHeating'
            ];
            
            analyzeButton.disabled = true;

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    const fileName = fileInput.files[0].name;
                    fileInfo.textContent = `Arquivo selecionado: ${fileName}`;
                    analyzeButton.disabled = false;
                } else {
                    fileInfo.textContent = '';
                    analyzeButton.disabled = true;
                }
            });
            
            fullscreenButton.addEventListener('click', () => {
                chartContainer.classList.toggle('fullscreen');
                backdrop.classList.toggle('hidden');
                expandIcon.classList.toggle('hidden');
                compressIcon.classList.toggle('hidden');
                setTimeout(() => {
                    if (givoniChart) {
                        givoniChart.resize();
                    }
                }, 50);
            });

            analyzeButton.addEventListener('click', handleFileAnalysis);
            toggleAllButton.addEventListener('click', () => {
                if (!givoniChart) return;
                const interactiveZones = Object.keys(zonesWithAH).filter(k => k !== 'zone1_comfort');
                const areMostOff = interactiveZones.filter(k => !zonesWithAH[k].visible).length > interactiveZones.length / 2;
                
                interactiveZones.forEach(key => {
                    zonesWithAH[key].visible = areMostOff;
                });

                zonesWithAH['zone2_4_intersection'].visible = zonesWithAH['zone2_ventilation'].visible && zonesWithAH['zone4_thermalMassCooling'].visible;
                
                analyzeData(epwData, zonesWithAH);
                givoniChart.update();
            });

            function handleFileAnalysis() {
                if (fileInput.files.length === 0) {
                    alert('Por favor, selecione um arquivo EPW.');
                    return;
                }
                const file = fileInput.files[0];
                const reader = new FileReader();
                loader.classList.remove('hidden');
                analyzeButton.disabled = true;
                fileInput.disabled = true;
                reader.onload = function(event) {
                    try {
                        const fileContent = event.target.result;
                        const parsedResult = parseEPW(fileContent);
                        epwData = parsedResult.data;
                        
                        locationDisplay.innerHTML = `<span>Localização: ${parsedResult.location.city}, ${parsedResult.location.state}, ${parsedResult.location.country}</span> <span class="ml-4">Período: ${parsedResult.period}</span>`;

                        chartPlaceholder.classList.add('hidden');
                        toggleAllButton.classList.remove('hidden');
                        chartExplanationDiv.classList.remove('hidden');
                        fullscreenButton.classList.remove('hidden');

                        createGivoniChart(epwData);
                    } catch (error) {
                        console.error('Erro ao processar o arquivo EPW:', error);
                        alert('Ocorreu um erro ao processar o arquivo. Verifique se é um arquivo .epw válido.');
                    } finally {
                        loader.classList.add('hidden');
                        analyzeButton.disabled = false;
                        fileInput.disabled = false;
                    }
                };
                reader.onerror = function() {
                    console.error('Erro ao ler o arquivo.');
                    alert('Não foi possível ler o arquivo selecionado.');
                    loader.classList.add('hidden');
                    analyzeButton.disabled = false;
                    fileInput.disabled = false;
                };
                reader.readAsText(file, "UTF-8");
            }

            function calculateAbsoluteHumidity(temp, rh) {
                if (rh < 0) rh = 0;
                if (rh > 100) rh = 100;
                const pSat = 610.78 * Math.exp((17.27 * temp) / (temp + 237.3));
                const pVapor = (rh / 100) * pSat;
                const pAtm = 101325;
                const mixingRatio = 0.622 * (pVapor / (pAtm - pVapor));
                return mixingRatio * 1000;
            }

            function parseEPW(content) {
                const lines = content.split('\n');
                
                const locationLine = lines[0].split(',');
                const location = {
                    city: locationLine[1] || 'N/A',
                    state: locationLine[2] || 'N/A',
                    country: locationLine[3] || 'N/A'
                };
                
                const dataLines = lines.slice(8).filter(line => line.trim() !== '');
                let period = 'N/A';
                if (dataLines.length > 0) {
                    const startYear = dataLines[0].split(',')[0];
                    const endYear = dataLines[dataLines.length - 1].split(',')[0];
                    period = startYear === endYear ? startYear : `${startYear} - ${endYear}`;
                }


                const parsedData = [];
                for (const line of dataLines) {
                    const columns = line.split(',');
                    if (columns.length < 9) continue;
                    
                    const month = parseInt(columns[1], 10);
                    const day = parseInt(columns[2], 10);
                    const hour = parseInt(columns[3], 10);
                    const dryBulbTemp = parseFloat(columns[6]);
                    const relHumidity = parseFloat(columns[8]);
                    
                    if (!isNaN(dryBulbTemp) && !isNaN(relHumidity)) {
                        let absHumidity = calculateAbsoluteHumidity(dryBulbTemp, relHumidity);
                        const maxHumidityAtTemp = calculateAbsoluteHumidity(dryBulbTemp, 100);
                        if (absHumidity > maxHumidityAtTemp) {
                            absHumidity = maxHumidityAtTemp;
                        }
                        parsedData.push({ month, day, hour, temp: dryBulbTemp, rh: relHumidity, ah: absHumidity });
                    }
                }
                return { data: parsedData, location: location, period: period };
            }

            function getGivoniZones() {
                 return {
                     zone1_comfort: { 
                        points: [ {x: 18, y: 4}, {x: 29, y: 4}, {x: 29, y: 12.5}, {x: 27, y: 17}, {x: 26, y: 17}, {x: 18, y: 10.5} ], 
                        color: 'rgba(119, 136, 153, 0.7)', label: '1 - Zona de Conforto', visible: true, labelPosition: {x: 23, y: 9}
                    },
                    zone2_4_intersection: {
                        points: [ {x: 27, y: 17},{x: 31.2, y: 17}, {x: 32, y: 15}, {x: 32, y: 4}, {x: 29, y: 4}, {x: 29, y: 12.5} ],
                        color: 'rgba(148, 0, 211, 0.4)', label: '2-4 Vent. e Massa Térmica', visible: false, labelPosition: {x: 30.5, y: 11}
                    },
                    zone2_ventilation: {
                        points:[ {x: 18, y: 10.5}, {x: 20, y: 12.125}, {x: 20, y: calculateAbsoluteHumidity(20, 100)}, {x: 25, y:20.1}, {x: 25.4, y: 20.5}, {x: 30, y: 20.5}, {x: 32, y: 15}, {x: 32, y: 4}, {x: 29, y: 4}, {x: 29, y: 12.5}, {x: 27, y: 17}, {x: 26, y: 17}, ],
                        color: 'rgba(135, 206, 250, 0.4)', label: '2 - Zona de Ventilação', visible: false, labelPosition: {x: 27, y: 18.5}
                    },
                    zone3_evaporativeCooling: {
                        points: [ {x: 30, y: 0}, {x: 44, y: 0}, {x: 44, y: 11}, {x: 33.8, y: 15}, {x: 38, y: 4}, {x: 20, y: 4} ],
                        color: 'rgba(30, 144, 255, 0.6)', label: '3 - Zona de Resfriamento Evaporativo', visible: false, labelPosition: {x: 39, y: 8}
                    },
                    zone4_thermalMassCooling: {
                        points: [ {x: 27, y: 17}, {x: 33, y: 17}, {x: 38, y: 4}, {x: 29, y: 4}, {x: 29, y: 12.5} ],
                        color: 'rgba(255, 105, 180, 0.6)', label: '4 - Zona de Massa Térmica', visible: false, labelPosition: {x: 34, y: 11}
                    },
                    zone5_airConditioning: {
                        points: [ {x: 25.4, y: 20.5}, {x: 30, y: 20.5}, {x: 31.2, y: 17}, {x: 33, y: 17}, {x: 33.8, y: 15}, {x: 44, y: 11}, {x: 44, y: 0}, {x: 50, y: 0}, {x: 50, y: 30}, {x: 31.8, y: 30}, {x: 31, y: calculateAbsoluteHumidity(31, 100)}, {x: 30, y: calculateAbsoluteHumidity(30, 100)}, {x: 29, y: calculateAbsoluteHumidity(29, 100)}, {x: 28, y: calculateAbsoluteHumidity(28, 100)}, {x: 27, y: calculateAbsoluteHumidity(27, 100)}, {x: 26, y: calculateAbsoluteHumidity(26, 100)}, {x: 25.4, y: calculateAbsoluteHumidity(25.4, 100)}, ],
                        color: 'rgba(220, 20, 60, 0.6)', label: '5 - Zona de Ar-Condicionado', visible: false, labelPosition: {x: 42, y: 18}
                    },
                    zone6_humidification: {
                        points: [ {x: 20, y: 0}, {x: 30, y: 0}, {x: 20, y: 4}, ],
                        color: 'rgba(60, 179, 113, 0.6)', label: '6 - Zona de Umidificação', visible: false, labelPosition: {x: 22, y: 1.5}
                    },
                     zone7_thermalMassHeating: {
                        points: [ {x: 14, y: 0}, {x: 20, y: 0}, {x: 20, y: 4}, {x: 18, y: 4}, {x: 18, y: 10.5}, {x: 20, y: 12.125}, {x: 20, y: calculateAbsoluteHumidity(20, 100)}, {x: 14, y: calculateAbsoluteHumidity(14, 100)}, ],
                        color: 'rgba(255, 215, 0, 0.6)', label: '7 - Zona de Massa Térmica para Aquecimento', visible: false, labelPosition: {x: 16, y: 6}
                    },
                    zone8_passiveSolarHeating: {
                        points: [ {x: 10, y: 0}, {x: 14, y: 0}, {x: 14, y: calculateAbsoluteHumidity(14, 100)}, {x: 12, y: calculateAbsoluteHumidity(12, 100)}, {x: 10, y: calculateAbsoluteHumidity(10, 100)}, ],
                        color: 'rgba(255, 165, 0, 0.6)', label: '8 - Zona de Aquecimento Solar Passivo', visible: false, labelPosition: {x: 12, y: 4}
                    },
                    zone9_artificialHeating: {
                        points: [ {x: -10, y: 0}, {x: 10, y: 0}, {x: 10, y: calculateAbsoluteHumidity(10, 100)}, {x: 5, y: calculateAbsoluteHumidity(5, 100)}, {x: 0, y: calculateAbsoluteHumidity(0, 100)}, {x: -5, y: calculateAbsoluteHumidity(-5, 100)}, {x: -10, y: calculateAbsoluteHumidity(-10, 100)}, ],
                        color: 'rgba(210, 105, 30, 0.6)', label: '9 - Zona de Aquecimento Artificial', visible: false, labelPosition: {x: 0, y: 2}
                    }
                };
            }

            function isPointInPolygon(point, polygon) {
                let isInside = false;
                const x = point.x, y = point.y;
                for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                    const xi = polygon[i].x, yi = polygon[i].y;
                    const xj = polygon[j].x, yj = polygon[j].y;
                    const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) isInside = !isInside;
                }
                return isInside;
            }

            function analyzeData(data, zones) {
                const zoneCounts = Object.keys(zones).reduce((acc, key) => {
                    acc[key] = { count: 0, label: zones[key].label };
                    return acc;
                }, {});

                const activeZones = Object.keys(zones).filter(key => zones[key].visible);
                const activePriorityOrder = ANALYSIS_PRIORITY_ORDER.filter(key => activeZones.includes(key));
                
                let comfortableCount = 0;

                data.forEach(point => {
                    let pointAssigned = false;
                    for (const zoneKey of activePriorityOrder) {
                        const zone = zones[zoneKey];
                        if (isPointInPolygon({x: point.temp, y: point.ah}, zone.points)) {
                            
                            if (zoneKey === 'zone2_ventilation' && zones['zone2_4_intersection'].visible && isPointInPolygon({x: point.temp, y: point.ah}, zones['zone2_4_intersection'].points)) {
                                continue; 
                            }
                            if (zoneKey === 'zone4_thermalMassCooling' && zones['zone2_4_intersection'].visible && isPointInPolygon({x: point.temp, y: point.ah}, zones['zone2_4_intersection'].points)) {
                                continue; 
                            }
                            
                            zoneCounts[zoneKey].count++;
                            pointAssigned = true;
                            break; 
                        }
                    }
                    if (pointAssigned) {
                        comfortableCount++;
                    }
                });

                summaryTableBody.innerHTML = '';
                const totalHours = data.length;
                const sortedZones = Object.entries(zones).sort((a,b) => a[1].label.localeCompare(b[1].label));
                
                sortedZones.forEach(([key, value]) => {
                    if (key === 'zone2_4_intersection' && !zones[key].visible) {
                        return;
                    }

                    const count = zoneCounts[key] ? zoneCounts[key].count : 0;
                    const percentage = totalHours > 0 ? (count / totalHours * 100).toFixed(1) : 0;
                    const row = document.createElement('tr');
                    row.dataset.zoneKey = key;

                    if (!zones[key].visible) {
                        row.style.opacity = '0.5';
                    }
                    
                    row.innerHTML = `
                        <td class="py-1.5 font-medium flex items-center">
                           <span class="inline-block w-4 h-4 rounded-full mr-3" style="background-color: ${zones[key].color};"></span>
                           ${value.label}
                        </td>
                        <td class="py-1.5 text-center">${count}</td>
                        <td class="py-1.5 text-right">${percentage}%</td>
                    `;
                    
                    if (key !== 'zone1_comfort') {
                        row.classList.add('interactive');
                        row.addEventListener('click', () => {
                            zones[key].visible = !zones[key].visible;
                            
                            zones['zone2_4_intersection'].visible = zones['zone2_ventilation'].visible && zones['zone4_thermalMassCooling'].visible;
                            
                            analyzeData(epwData, zones);
                            givoniChart.update();
                        });
                    }

                    summaryTableBody.appendChild(row);
                });
                analysisResults.classList.remove('hidden');

                if (totalHours > 0) {
                    const comfortablePercent = (comfortableCount / totalHours * 100);
                    comfortablePercentSpan.textContent = `${comfortablePercent.toFixed(1)}%`;
                    uncomfortablePercentSpan.textContent = `${(100 - comfortablePercent).toFixed(1)}%`;
                } else {
                    comfortablePercentSpan.textContent = '--%';
                    uncomfortablePercentSpan.textContent = '--%';
                }
                comfortSummaryDiv.classList.remove('hidden');
                generateAnalysisText(zoneCounts, totalHours, zones);
            }

            function generateAnalysisText(zoneCounts, totalHours, zones) {
                const recommendations = {
                    zone2_ventilation: { name: "Ventilação Natural", text: "Medidas como ventilação cruzada (janelas em faces opostas), aberturas permanentes e o efeito chaminé para induzir a circulação do ar são altamente recomendadas." },
                    zone3_evaporativeCooling: { name: "Resfriamento Evaporativo", text: "O uso de fontes, espelhos d'água próximos às aberturas, pátios internos com vegetação e o uso de materiais porosos no exterior pode reduzir significativamente a temperatura do ar." },
                    zone4_thermalMassCooling: { name: "Massa Térmica para Resfriamento", text: "Materiais como concreto, tijolo maciço ou pedra podem absorver o calor durante o dia e liberá-lo para o exterior durante a noite." },
                    zone2_4_intersection: { name: "Ventilação e Massa Térmica", text: "A combinação de alta inércia térmica com ventilação noturna é a estratégia mais indicada. Use materiais como concreto, tijolo ou pedra para absorver calor durante o dia, e promova ventilação intensa durante a noite para resfriar a estrutura." },
                    zone7_thermalMassHeating: { name: "Massa Térmica para Aquecimento", text: "Materiais de alta inércia térmica expostos à radiação solar podem armazenar calor e liberá-lo lentamente para aquecer o interior durante a noite." },
                    zone8_passiveSolarHeating: { name: "Aquecimento Solar Passivo", text: "É uma estratégia chave. Recomenda-se o uso de aberturas de vidro voltadas para a orientação solar favorável para ganho de calor direto, além de estufas e paredes de Trombe." }
                };

                const getEfficacyLabel = (percent) => {
                    if (percent >= 75) return 'extremamente eficaz';
                    if (percent >= 50) return 'eficaz';
                    if (percent >= 25) return 'possivelmente eficaz';
                    return 'pouco eficaz';
                };

                const comfortCount = zoneCounts['zone1_comfort'] ? zoneCounts['zone1_comfort'].count : 0;
                const comfortPercent = totalHours > 0 ? (comfortCount / totalHours * 100) : 0;
                let analysisHTML = `<p class="mb-2">A análise indica que <strong>${comfortPercent.toFixed(1)}%</strong> das horas do ano estão dentro da zona de conforto natural.</p>`;
                
                const activePassiveStrategiesKeys = Object.keys(recommendations).filter(key => zones[key] && zones[key].visible);

                if (activePassiveStrategiesKeys.length > 0) {
                    const passiveStrategies = activePassiveStrategiesKeys
                        .map(key => {
                            let count = zoneCounts[key] ? zoneCounts[key].count : 0;
                            if(key === 'zone2_ventilation' && zones['zone2_4_intersection'].visible) {
                                count += zoneCounts['zone2_4_intersection'].count;
                            }
                             if(key === 'zone4_thermalMassCooling' && zones['zone2_4_intersection'].visible) {
                                count += zoneCounts['zone2_4_intersection'].count;
                            }
                            return { key, count, percent: totalHours > 0 ? (count / totalHours * 100) : 0 };
                        })
                        .sort((a, b) => b.count - a.count);

                    let topStrategies = passiveStrategies.filter(s => s.count > 0);
                    
                    if (topStrategies.length > 1) {
                        const topKey = topStrategies[0].key;
                        if (topKey === 'zone2_4_intersection') {
                            topStrategies = [topStrategies[0]].concat(topStrategies.slice(1).filter(s => s.key !== 'zone2_ventilation' && s.key !== 'zone4_thermalMassCooling'));
                        } else if (topKey === 'zone2_ventilation' || topKey === 'zone4_thermalMassCooling') {
                             topStrategies = [topStrategies[0]].concat(topStrategies.slice(1).filter(s => s.key !== 'zone2_4_intersection'));
                        }
                    }

                    if (topStrategies.length > 0) {
                        const topStrategyData = topStrategies[0];
                        const topStrategyInfo = recommendations[topStrategyData.key];
                        const topEfficacy = getEfficacyLabel(topStrategyData.percent);

                        analysisHTML += `<p class="mt-4">Para as horas de desconforto, a principal estratégia passiva ativa é a <strong>${topStrategyInfo.name}</strong> (potencial de <strong>${topStrategyData.percent.toFixed(1)}%</strong>), considerada <strong>${topEfficacy}</strong>.</p><p class="text-gray-400 text-xs">${topStrategyInfo.text}</p>`;

                        if (topStrategies.length > 1) {
                            const secondStrategyData = topStrategies[1];
                            const secondStrategyInfo = recommendations[secondStrategyData.key];
                            const secondEfficacy = getEfficacyLabel(secondStrategyData.percent);
                            analysisHTML += `<p class="mt-3">A segunda estratégia mais relevante é a <strong>${secondStrategyInfo.name}</strong> (potencial de <strong>${secondStrategyData.percent.toFixed(1)}%</strong>), considerada <strong>${secondEfficacy}</strong>.</p><p class="text-gray-400 text-xs">${secondStrategyInfo.text}</p>`;
                        }
                    }
                } else {
                    if (comfortPercent < 100) {
                         analysisHTML += `<p class="mt-4">Nenhuma estratégia passiva adicional está ativa. A análise se baseia apenas na Zona de Conforto. Para as <strong>${(100 - comfortPercent).toFixed(1)}%</strong> das horas de desconforto, seria necessário o uso de estratégias que requerem sistemas mecânicos ou a habilitação de outras zonas para análise.</p>`;
                    }
                }
                
                analysisTextDiv.innerHTML = analysisHTML;
                strategyAnalysisDiv.classList.remove('hidden');
            }
            
            const customAnnotationsPlugin = {
                id: 'customAnnotationsPlugin',
                afterDraw: (chart, args, options) => {
                    const { ctx, chartArea, scales: { x, y } } = chart;
                    
                    ctx.save();
                    ctx.font = '12px Inter';
                    ctx.fillStyle = '#ccc';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const yTitleX = chartArea.right + 40;
                    const yTitleY = chartArea.top + (chartArea.height / 2);
                    ctx.translate(yTitleX, yTitleY);
                    ctx.rotate(-Math.PI / 2);
                    ctx.fillText('Umidade Absoluta (g/kg)', 0, 0);
                    ctx.restore();
                }
            };

            const givoniZonesPlugin = {
                id: 'givoniZonesPlugin',
                afterDatasetsDraw: (chart, args, options) => {
                    const { ctx, scales: { x, y } } = chart;
                    const zones = options.zones;
                    if (!zones || Object.keys(zones).length === 0) return;

                    const drawOrder = [
                        'zone9_artificialHeating', 'zone8_passiveSolarHeating', 'zone7_thermalMassHeating',
                        'zone6_humidification', 'zone5_airConditioning', 'zone3_evaporativeCooling',
                        'zone1_comfort', 'zone4_thermalMassCooling', 'zone2_ventilation', 'zone2_4_intersection'
                    ];

                    ctx.save();
                    drawOrder.forEach(zoneKey => {
                        const zone = zones[zoneKey];
                        if (!zone || !zone.visible) return;

                        if (zoneKey === 'zone2_4_intersection' && (!zones['zone2_ventilation'].visible || !zones['zone4_thermalMassCooling'].visible)) {
                            return; 
                        }

                        ctx.beginPath();
                        const firstPoint = zone.points[0];
                        ctx.moveTo(x.getPixelForValue(firstPoint.x), y.getPixelForValue(firstPoint.y));
                        for (let i = 1; i < zone.points.length; i++) {
                            const point = zone.points[i];
                            ctx.lineTo(x.getPixelForValue(point.x), y.getPixelForValue(point.y));
                        }
                        ctx.closePath();
                        
                        ctx.fillStyle = zone.color;
                        ctx.fill();

                        ctx.strokeStyle = 'rgba(200, 200, 200, 0.7)';
                        ctx.lineWidth = 1.5;
                        ctx.stroke();

                        if (zone.labelPosition) {
                           ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                           ctx.font = 'bold 14px Inter';
                           ctx.textAlign = 'center';
                           ctx.textBaseline = 'middle';
                           const labelX = x.getPixelForValue(zone.labelPosition.x);
                           const labelY = y.getPixelForValue(zone.labelPosition.y);
                           const labelText = zone.label.split(' ')[0].replace('_', '-');
                           ctx.fillText(labelText, labelX, labelY);
                        }
                    });
                    ctx.restore();
                }
            };
            
            function createGivoniChart(data) {
                const ctx = document.getElementById('givoni-chart').getContext('2d');
                zonesWithAH = getGivoniZones();

                const rhCurvesData = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100].map(rh => {
                    const curvePoints = [];
                    for (let temp = -10; temp <= 50; temp += 1) { 
                        curvePoints.push({ x: temp, y: calculateAbsoluteHumidity(temp, rh) });
                    }
                    return { type: 'line', label: `${rh}%`, data: curvePoints, borderColor: 'rgba(200, 200, 200, 0.5)', borderWidth: 1, borderDash: [2, 2], pointRadius: 0, fill: false, tension: 0 };
                });

                const processedChartData = data.map(d => {
                    return { x: d.temp, y: d.ah, rh: d.rh, month: d.month, day: d.day, hour: d.hour };
                });

                if (givoniChart) {
                    givoniChart.destroy();
                }

                givoniChart = new Chart(ctx, {
                    plugins: [givoniZonesPlugin, customAnnotationsPlugin],
                    data: {
                        datasets: [ ...rhCurvesData, { 
                            type: 'scatter', 
                            label: 'Dados Climáticos Horários', 
                            data: processedChartData, 
                            pointRadius: 1.5, 
                            pointHoverRadius: 3, 
                            pointBackgroundColor: context => {
                                const point = context.raw;
                                let isInActiveZone = false;
                                for (const key in zonesWithAH) {
                                    const zone = zonesWithAH[key];
                                    if (zone.visible && isPointInPolygon({x: point.x, y: point.y}, zone.points)) {
                                        isInActiveZone = true;
                                        break;
                                    }
                                }
                                return isInActiveZone ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.7)';
                            },
                            pointBorderColor: context => {
                                const point = context.raw;
                                let isInActiveZone = false;
                                for (const key in zonesWithAH) {
                                    const zone = zonesWithAH[key];
                                    if (zone.visible && isPointInPolygon({x: point.x, y: point.y}, zone.points)) {
                                        isInActiveZone = true;
                                        break;
                                    }
                                }
                                return isInActiveZone ? 'rgba(46, 204, 113, 1)' : 'rgba(231, 76, 60, 1)';
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                right: 50 
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear', position: 'bottom',
                                title: { display: true, text: 'Temperatura de Bulbo Seco (°C)', color: '#ccc' },
                                min: -10, max: 50,
                                ticks: {
                                    color: '#ccc',
                                    stepSize: 1,
                                    callback: (value) => (value % 5 === 0 ? value : null)
                                },
                                grid: {
                                    color: (context) => (context.tick.value % 5 === 0 ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.08)'),
                                    lineWidth: (context) => (context.tick.value % 5 === 0 ? 1 : 0.5)
                                }
                            },
                            y: {
                                position: 'right',
                                title: { display: false },
                                min: 0, max: 30,
                                ticks: {
                                    color: '#ccc',
                                    stepSize: 1,
                                    callback: (value) => (value % 5 === 0 ? value : null)
                                },
                                grid: {
                                    color: (context) => (context.tick.value % 5 === 0 ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.08)'),
                                    lineWidth: (context) => (context.tick.value % 5 === 0 ? 1 : 0.5)
                                }
                            }
                        },
                        plugins: {
                            givoniZonesPlugin: { zones: zonesWithAH },
                            legend: { 
                                display: false, 
                            },
                            tooltip: {
                                callbacks: {
                                    title: function() {
                                        return ''; // Remove o título padrão do tooltip
                                    },
                                    label: function(context) {
                                        const datasetLabel = context.dataset.label || '';
                                        if (datasetLabel.includes('Dados Climáticos')) {
                                            const originalData = context.raw;
                                            const monthNamesShort = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                                            const month = monthNamesShort[originalData.month - 1];
                                            const day = originalData.day;
                                            const hour = (originalData.hour - 1).toString().padStart(2, '0');
                                            
                                            const title = `${day} de ${month}, ${hour}:00`;
                                            const tempLine = `Temp: ${originalData.x.toFixed(1)}°C`;
                                            const ahLine = `Umid. Abs: ${originalData.y.toFixed(1)} g/kg`;
                                            const rhLine = `Umid. Rel: ${originalData.rh.toFixed(0)}%`;
                                            return [title, tempLine, ahLine, rhLine];
                                        }
                                        return `Umidade Relativa: ${datasetLabel}`;
                                    }
                                }
                            }
                        }
                    }
                });
                analyzeData(epwData, zonesWithAH);
            }
        };
    </script>

</body>
</html>

